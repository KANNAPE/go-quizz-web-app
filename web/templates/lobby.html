{{ define "title" }}Lobby - {{ .LobbyID }}{{ end }}

{{ define "content" }}
<h1>Lobby ID: {{ .LobbyID }}</h1>
<p>Welcome, {{ .Username }}!</p>

<p>Share this link with friends to join:</p>
<pre>{{ .JoinURL }}</pre>

<hr>

{{ if not .Username }}
<h2>Choose a username to join</h2>
<form action="/lobby" method="POST">
    <input type="hidden" name="lobbyID" value="{{ .LobbyID }}" />
    <input type="text" name="username" placeholder="Enter username" required />
    <button type="submit">Join lobby</button>
</form>
{{ else }}
<h2>Chat</h2>
<div id="chat-box" style="border:1px solid #ccc; height:200px; overflow-y:auto; padding:5px;"></div>

<form id="chat-form" style="margin-top:10px;">
    <input id="chat-input" autocomplete="off" placeholder="Type a message..." style="width:80%;" />
    <button>Send</button>
</form>

<script>
const wsScheme = location.protocol === "https:" ? "wss" : "ws";
const wsUrl = wsScheme + "://" + location.host + location.pathname; // SAME /lobby/{id}
const ws = new WebSocket(wsUrl);

ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    const box = document.getElementById("chat-box");
    const div = document.createElement("div");
    div.textContent = msg.username + ": " + msg.text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
};

document.getElementById("chat-form").onsubmit = (e) => {
    e.preventDefault();
    const input = document.getElementById("chat-input");
    if (input.value.trim() !== "") {
        ws.send(input.value);
        input.value = "";
    }
};
</script>
{{ end }}
{{ end }}
